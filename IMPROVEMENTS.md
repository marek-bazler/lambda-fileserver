# Large File Upload/Download Improvements

## Problem with Original Design
- Lambda has 6MB payload limit
- Base64 encoding adds 33% overhead (4MB file → 5.3MB)
- Lambda timeout is 30 seconds max
- Movies are typically 100MB-10GB+

## New Architecture: Direct S3 Upload/Download

### Upload Flow
1. **Client calculates SHA-256 hash** (in browser, no server load)
2. **Check for duplicate** via Lambda (tiny request)
3. **Get presigned S3 URL** from Lambda (no file data)
4. **Upload directly to S3** (browser → S3, bypasses Lambda)
5. **Notify Lambda** of completion (store metadata)

### Download Flow
1. **Request download** from Lambda
2. **Get presigned S3 URL** (valid for 1 hour)
3. **Download directly from S3** (bypasses Lambda)

## Benefits

### Cost Savings
- **Lambda invocations**: Reduced from 1 per file to 3 tiny requests
- **Lambda data transfer**: $0 (was $0.09/GB)
- **Lambda execution time**: ~100ms vs 30s timeout
- **S3 transfer**: Direct (no double transfer through Lambda)

### Performance
- **No size limits**: Upload files of any size
- **Progress tracking**: Real-time upload progress bar
- **Parallel uploads**: Can upload multiple files simultaneously
- **Faster**: Direct S3 connection, no Lambda proxy

### Reliability
- **No timeouts**: Lambda only handles metadata
- **Resumable**: Can implement multipart upload for huge files
- **Better error handling**: Separate hash check, upload, metadata steps

## Cost Comparison (1GB movie file)

### Old Method (Base64 through Lambda)
- ❌ Impossible (exceeds 6MB limit)

### New Method (Direct S3)
- Lambda: 3 requests × $0.0000002 = $0.0000006
- S3 PUT: $0.005 per 1000 requests = $0.000005
- S3 storage: $0.023/GB/month
- **Total per upload: ~$0.000006**

## Technical Details

### Presigned URLs
- Generated by Lambda using AWS SDK
- Valid for 1 hour (configurable)
- Includes authentication in URL
- No additional AWS credentials needed in browser

### Hash Calculation
- SHA-256 computed in browser using Web Crypto API
- Happens before upload (duplicate check)
- No server resources used

### Security
- Presigned URLs are time-limited
- File ownership verified before generating URLs
- Each user can only access their own files
