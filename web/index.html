<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>File Server</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container { max-width: 1000px; margin: 0 auto; }
        
        .card { 
            background: white; 
            border-radius: 16px; 
            padding: 32px; 
            margin-bottom: 24px; 
            box-shadow: 0 10px 40px rgba(0,0,0,0.1);
            backdrop-filter: blur(10px);
        }
        
        .header-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            position: relative;
            overflow: hidden;
        }
        
        .header-card::before {
            content: '';
            position: absolute;
            top: -50%;
            right: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%);
            animation: pulse 15s ease-in-out infinite;
        }
        
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }
        
        h1 { 
            color: white;
            margin-bottom: 8px;
            font-size: 32px;
            font-weight: 700;
            position: relative;
            z-index: 1;
        }
        
        .subtitle {
            color: rgba(255,255,255,0.9);
            font-size: 14px;
            position: relative;
            z-index: 1;
        }
        
        h2 { 
            color: #333; 
            margin-bottom: 20px; 
            font-size: 20px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        h2::before {
            content: '';
            width: 4px;
            height: 24px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 2px;
        }
        
        input, button { 
            padding: 14px 20px; 
            border-radius: 10px; 
            border: 2px solid #e0e0e0; 
            font-size: 15px;
            transition: all 0.3s ease;
        }
        
        input { 
            width: 100%; 
            margin-bottom: 16px;
            font-family: inherit;
        }
        
        input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        button { 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white; 
            border: none; 
            cursor: pointer; 
            font-weight: 600;
            width: 100%;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        
        button:hover { 
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
        }
        
        button:active {
            transform: translateY(0);
        }
        
        button:disabled { 
            background: #ccc; 
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        .hidden { display: none; }
        
        .file-list { list-style: none; }
        
        .file-item { 
            padding: 16px; 
            border-bottom: 1px solid #f0f0f0; 
            display: flex; 
            justify-content: space-between; 
            align-items: center;
            transition: background 0.2s;
        }
        
        .file-item:hover {
            background: #f8f9fa;
        }
        
        .file-item:last-child { border-bottom: none; }
        
        .file-info { flex: 1; }
        
        .file-name { 
            font-weight: 600; 
            color: #333;
            margin-bottom: 4px;
        }
        
        .file-meta { 
            font-size: 13px; 
            color: #888;
            display: flex;
            gap: 12px;
            align-items: center;
        }
        
        .file-meta span {
            display: flex;
            align-items: center;
            gap: 4px;
        }
        
        .btn-small { 
            padding: 8px 16px; 
            font-size: 13px; 
            margin-left: 8px;
            width: auto;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        
        .error { 
            color: #dc3545; 
            margin-top: 12px; 
            font-size: 14px;
            padding: 12px;
            background: #ffe6e6;
            border-radius: 8px;
            border-left: 4px solid #dc3545;
        }
        
        .success { 
            color: #28a745; 
            margin-top: 12px; 
            font-size: 14px;
            padding: 12px;
            background: #e6ffe6;
            border-radius: 8px;
            border-left: 4px solid #28a745;
        }
        
        .upload-area { 
            border: 3px dashed #ddd; 
            border-radius: 12px; 
            padding: 60px 40px; 
            text-align: center; 
            cursor: pointer; 
            margin-bottom: 20px;
            transition: all 0.3s ease;
            background: #fafafa;
        }
        
        .upload-area:hover { 
            border-color: #667eea; 
            background: #f0f4ff;
            transform: translateY(-2px);
        }
        
        .upload-icon {
            font-size: 48px;
            margin-bottom: 16px;
            opacity: 0.5;
        }
        
        .upload-text {
            font-size: 18px;
            font-weight: 600;
            color: #333;
            margin-bottom: 8px;
        }
        
        .upload-subtext {
            font-size: 14px;
            color: #888;
        }
        
        .logout-btn { 
            float: right; 
            background: rgba(255,255,255,0.2);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.3);
            padding: 8px 16px;
            font-size: 14px;
            width: auto;
            position: relative;
            z-index: 10;
            cursor: pointer;
        }
        
        .logout-btn:hover { 
            background: rgba(255,255,255,0.3);
            transform: none;
        }
        
        .welcome-text {
            color: white;
            font-size: 16px;
            position: relative;
            z-index: 1;
        }
        
        .welcome-text strong {
            font-weight: 600;
        }
        
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #888;
        }
        
        .empty-state-icon {
            font-size: 64px;
            opacity: 0.3;
            margin-bottom: 16px;
        }
        
        .progress-bar {
            width: 100%;
            height: 6px;
            background: #e0e0e0;
            border-radius: 3px;
            overflow: hidden;
            margin-top: 8px;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            transition: width 0.3s ease;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Login Section -->
        <div id="loginSection" class="card">
            <h1>üé¨ Movie Archive</h1>
            <p class="subtitle" style="color: #666; margin-bottom: 24px;">Secure cloud storage for your media files</p>
            <input type="text" id="username" placeholder="Username" />
            <input type="password" id="password" placeholder="Password" />
            <button onclick="login()">Sign In</button>
            <div id="loginError" class="error hidden"></div>
        </div>

        <!-- Main Section -->
        <div id="mainSection" class="hidden">
            <div class="card header-card">
                <button class="logout-btn btn-small" onclick="logout()">Logout</button>
                <h1>üé¨ Movie Archive</h1>
                <p class="welcome-text">Welcome back, <strong id="currentUser"></strong></p>
            </div>

            <!-- Upload Section -->
            <div class="card">
                <h2>Upload Files</h2>
                <div class="upload-area" onclick="document.getElementById('fileInput').click()">
                    <div class="upload-icon">üìÅ</div>
                    <div class="upload-text">Drop files here or click to browse</div>
                    <div class="upload-subtext">Supports large files with automatic multipart upload</div>
                </div>
                <input type="file" id="fileInput" multiple style="display: none;" onchange="handleFiles(this.files)" />
                
                <!-- Selected Files Preview -->
                <div id="selectedFilesPreview" class="hidden" style="margin: 20px 0;">
                    <h3 style="font-size: 16px; margin-bottom: 12px; color: #333;">Selected Files</h3>
                    <ul id="selectedFilesList" class="file-list" style="max-height: 300px; overflow-y: auto; border: 1px solid #e0e0e0; border-radius: 8px;"></ul>
                    <div style="margin-top: 12px; display: flex; gap: 12px;">
                        <button onclick="uploadFiles()" id="uploadBtn" style="flex: 1;">Upload <span id="fileCount"></span></button>
                        <button onclick="clearSelection()" style="flex: 0; background: #dc3545; width: auto; padding: 14px 24px;">Clear</button>
                    </div>
                </div>
                
                <div id="uploadStatus" class="hidden"></div>
            </div>

            <!-- Files List -->
            <div class="card">
                <h2>Your Files</h2>
                <ul id="filesList" class="file-list"></ul>
            </div>
        </div>
    </div>

    <script>
        const API_ENDPOINT = 'https://7873xzc0g1.execute-api.us-east-1.amazonaws.com'; 
        let token = localStorage.getItem('token');
        let selectedFiles = [];

        if (token) {
            document.getElementById('loginSection').classList.add('hidden');
            document.getElementById('mainSection').classList.remove('hidden');
            document.getElementById('currentUser').textContent = localStorage.getItem('username');
            loadFiles();
        }

        async function login() {
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            const errorDiv = document.getElementById('loginError');

            try {
                const response = await fetch(`${API_ENDPOINT}/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, password })
                });

                const data = await response.json();

                if (response.ok) {
                    token = data.token;
                    localStorage.setItem('token', token);
                    localStorage.setItem('username', username);
                    document.getElementById('loginSection').classList.add('hidden');
                    document.getElementById('mainSection').classList.remove('hidden');
                    document.getElementById('currentUser').textContent = username;
                    loadFiles();
                } else {
                    errorDiv.textContent = data.error || 'Login failed';
                    errorDiv.classList.remove('hidden');
                }
            } catch (error) {
                errorDiv.textContent = 'Network error';
                errorDiv.classList.remove('hidden');
            }
        }

        function logout() {
            console.log('Logout clicked');
            localStorage.removeItem('token');
            localStorage.removeItem('username');
            token = null;
            
            console.log('Token cleared, showing login screen');
            
            // Show login, hide main
            document.getElementById('loginSection').classList.remove('hidden');
            document.getElementById('mainSection').classList.add('hidden');
            
            // Clear form
            document.getElementById('username').value = '';
            document.getElementById('password').value = '';
            
            console.log('Logout complete');
        }

        function handleFiles(files) {
            selectedFiles = Array.from(files);
            
            if (selectedFiles.length === 0) {
                document.getElementById('selectedFilesPreview').classList.add('hidden');
                return;
            }
            
            // Show preview
            document.getElementById('selectedFilesPreview').classList.remove('hidden');
            document.getElementById('fileCount').textContent = `${selectedFiles.length} File${selectedFiles.length > 1 ? 's' : ''}`;
            
            // Build file list
            const filesList = document.getElementById('selectedFilesList');
            let totalSize = 0;
            
            filesList.innerHTML = selectedFiles.map((file, index) => {
                totalSize += file.size;
                const icon = getFileIcon(file.name);
                const uploadType = file.size > 100 * 1024 * 1024 ? '‚ö° Multipart' : 'üì§ Direct';
                
                return `
                    <li class="file-item" style="padding: 12px;">
                        <div class="file-info">
                            <div class="file-name">${icon} ${escapeHtml(file.name)}</div>
                            <div class="file-meta">
                                <span>üì¶ ${formatBytes(file.size)}</span>
                                <span>${uploadType}</span>
                            </div>
                        </div>
                        <button onclick="removeFile(${index})" class="btn-small" style="background: #dc3545; padding: 6px 12px;">‚úï</button>
                    </li>
                `;
            }).join('');
            
            // Add total size footer
            filesList.innerHTML += `
                <li style="padding: 12px; background: #f8f9fa; font-weight: 600; border-top: 2px solid #e0e0e0;">
                    <div style="display: flex; justify-content: space-between;">
                        <span>Total: ${selectedFiles.length} file${selectedFiles.length > 1 ? 's' : ''}</span>
                        <span>${formatBytes(totalSize)}</span>
                    </div>
                </li>
            `;
        }
        
        function removeFile(index) {
            selectedFiles.splice(index, 1);
            
            if (selectedFiles.length === 0) {
                clearSelection();
            } else {
                // Recreate FileList-like array
                const dt = new DataTransfer();
                selectedFiles.forEach(file => dt.items.add(file));
                document.getElementById('fileInput').files = dt.files;
                handleFiles(selectedFiles);
            }
        }
        
        function clearSelection() {
            selectedFiles = [];
            document.getElementById('fileInput').value = '';
            document.getElementById('selectedFilesPreview').classList.add('hidden');
            document.getElementById('uploadStatus').classList.add('hidden');
        }

        async function uploadFiles() {
            if (selectedFiles.length === 0) return;

            const statusDiv = document.getElementById('uploadStatus');
            statusDiv.innerHTML = '<p>Processing files...</p>';
            statusDiv.className = '';

            let successCount = 0;
            let duplicateCount = 0;
            let errorCount = 0;

            for (let i = 0; i < selectedFiles.length; i++) {
                const file = selectedFiles[i];
                statusDiv.innerHTML = `<p>Processing ${i + 1}/${selectedFiles.length}: ${file.name}</p>`;

                try {
                    // Calculate file hash for duplicate detection
                    const fileHash = await calculateFileHash(file);

                    // Check for duplicate
                    const dupCheck = await fetch(`${API_ENDPOINT}/check-duplicate`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${token}`
                        },
                        body: JSON.stringify({ file_hash: fileHash })
                    });

                    const dupData = await dupCheck.json();

                    if (dupData.duplicate) {
                        duplicateCount++;
                        statusDiv.innerHTML = `<p>Processing ${i + 1}/${selectedFiles.length}: ${file.name} (duplicate, skipped)</p>`;
                        continue;
                    }

                    // Get presigned upload URL
                    const urlResponse = await fetch(`${API_ENDPOINT}/upload`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${token}`
                        },
                        body: JSON.stringify({
                            files: [{
                                filename: file.name,
                                content_type: file.type || 'video/mp4',
                                size: file.size
                            }]
                        })
                    });

                    const urlData = await urlResponse.json();
                    
                    if (!urlResponse.ok || !urlData.upload_urls) {
                        console.error('Upload URL request failed:', urlData);
                        throw new Error(urlData.error || 'Failed to get upload URL');
                    }
                    const uploadInfo = urlData.upload_urls[0];

                    // Upload directly to S3 with progress
                    statusDiv.innerHTML = `<p>Uploading ${i + 1}/${selectedFiles.length}: ${file.name} (0%)</p>`;

                    let uploadResult;
                    try {
                        if (uploadInfo.upload_type === 'multipart') {
                            uploadResult = await uploadMultipart(file, uploadInfo, (percent) => {
                                statusDiv.innerHTML = `<p>Uploading ${i + 1}/${selectedFiles.length}: ${file.name} (${percent}%)</p>`;
                            });
                        } else {
                            uploadResult = await uploadSimple(file, uploadInfo, (percent) => {
                                statusDiv.innerHTML = `<p>Uploading ${i + 1}/${selectedFiles.length}: ${file.name} (${percent}%)</p>`;
                            });
                        }
                    } catch (uploadError) {
                        throw new Error(`S3 upload failed: ${uploadError.message}`);
                    }

                    // Notify backend of successful upload
                    await fetch(`${API_ENDPOINT}/upload-complete`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${token}`
                        },
                        body: JSON.stringify({
                            file_id: uploadInfo.file_id,
                            filename: file.name,
                            file_hash: fileHash,
                            size: file.size,
                            content_type: uploadInfo.content_type,
                            upload_id: uploadResult.upload_id,
                            parts: uploadResult.parts
                        })
                    });

                    successCount++;
                } catch (error) {
                    console.error('Upload error:', error);
                    statusDiv.innerHTML = `<p class="error">Error uploading ${file.name}: ${error.message}</p>`;
                    errorCount++;
                }
            }

            if (errorCount > 0) {
                statusDiv.innerHTML = `<p class="error">‚úó ${successCount} uploaded, ${duplicateCount} duplicates skipped, ${errorCount} errors</p>`;
            } else {
                statusDiv.innerHTML = `<p class="success">‚úì ${successCount} uploaded, ${duplicateCount} duplicates skipped</p>`;
            }
            
            clearSelection();
            loadFiles();
        }

        async function uploadSimple(file, uploadInfo, onProgress) {
            return new Promise((resolve, reject) => {
                const xhr = new XMLHttpRequest();
                
                xhr.upload.addEventListener('progress', (e) => {
                    if (e.lengthComputable) {
                        const percent = Math.round((e.loaded / e.total) * 100);
                        onProgress(percent);
                    }
                });

                xhr.addEventListener('load', () => {
                    if (xhr.status === 200 || xhr.status === 204) {
                        resolve({});
                    } else {
                        reject(new Error(`Upload failed with status ${xhr.status}`));
                    }
                });

                xhr.addEventListener('error', () => reject(new Error('Network error during upload')));

                xhr.open('PUT', uploadInfo.upload_url);
                xhr.setRequestHeader('Content-Type', uploadInfo.content_type);
                xhr.send(file);
            });
        }

        async function uploadMultipart(file, uploadInfo, onProgress) {
            const partSize = uploadInfo.part_size;
            const parts = [];
            let uploadedBytes = 0;

            for (let i = 0; i < uploadInfo.part_urls.length; i++) {
                const start = i * partSize;
                const end = Math.min(start + partSize, file.size);
                const chunk = file.slice(start, end);

                const response = await fetch(uploadInfo.part_urls[i], {
                    method: 'PUT',
                    body: chunk
                });

                if (!response.ok) {
                    throw new Error(`Part ${i + 1} upload failed`);
                }

                const etag = response.headers.get('ETag');
                parts.push({
                    PartNumber: i + 1,
                    ETag: etag
                });

                uploadedBytes += chunk.size;
                const percent = Math.round((uploadedBytes / file.size) * 100);
                onProgress(percent);
            }

            return {
                upload_id: uploadInfo.upload_id,
                parts: parts
            };
        }

        async function calculateFileHash(file) {
            // crypto.subtle only works on HTTPS or localhost
            if (!window.crypto || !window.crypto.subtle) {
                console.warn('crypto.subtle not available (HTTP site), using filename-based hash');
                // Fallback: use filename + size as pseudo-hash
                return `fallback-${file.name}-${file.size}`;
            }
            
            try {
                const buffer = await file.arrayBuffer();
                const hashBuffer = await crypto.subtle.digest('SHA-256', buffer);
                const hashArray = Array.from(new Uint8Array(hashBuffer));
                return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
            } catch (error) {
                console.warn('Hash calculation failed, using fallback:', error);
                return `fallback-${file.name}-${file.size}`;
            }
        }

        async function loadFiles() {
            try {
                const response = await fetch(`${API_ENDPOINT}/files`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                const data = await response.json();

                if (response.ok) {
                    const filesList = document.getElementById('filesList');
                    if (data.files.length === 0) {
                        filesList.innerHTML = `
                            <div class="empty-state">
                                <div class="empty-state-icon">üìÇ</div>
                                <p>No files uploaded yet</p>
                                <p style="font-size: 13px; margin-top: 8px;">Upload your first file to get started</p>
                            </div>
                        `;
                    } else {
                        filesList.innerHTML = data.files.map(file => {
                            const icon = getFileIcon(file.filename);
                            return `
                            <li class="file-item">
                                <div class="file-info">
                                    <div class="file-name">${icon} ${escapeHtml(file.filename)}</div>
                                    <div class="file-meta">
                                        <span>üì¶ ${formatBytes(file.size)}</span>
                                        <span>üìÖ ${new Date(file.uploaded_at).toLocaleDateString()}</span>
                                        <span>üïê ${new Date(file.uploaded_at).toLocaleTimeString()}</span>
                                    </div>
                                </div>
                                <div style="display: flex; gap: 8px;">
                                    <button class="btn-small" onclick="downloadFile('${file.file_id}', '${escapeHtml(file.filename)}')">‚¨áÔ∏è Download</button>
                                    <button class="btn-small" onclick="deleteFile('${file.file_id}', '${escapeHtml(file.filename)}')" style="background: #dc3545;">üóëÔ∏è Delete</button>
                                </div>
                            </li>
                        `}).join('');
                    }
                }
            } catch (error) {
                console.error('Failed to load files', error);
            }
        }

        async function downloadFile(fileId, filename) {
            try {
                const response = await fetch(`${API_ENDPOINT}/download?file_id=${encodeURIComponent(fileId)}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                const data = await response.json();

                if (response.ok) {
                    const a = document.createElement('a');
                    a.href = data.download_url;
                    a.download = filename;
                    a.click();
                }
            } catch (error) {
                alert('Download failed');
            }
        }



        function formatBytes(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i];
        }

        async function deleteFile(fileId, filename) {
            if (!confirm(`Are you sure you want to delete "${filename}"?\n\nThis action cannot be undone.`)) {
                return;
            }

            try {
                const response = await fetch(`${API_ENDPOINT}/delete`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({ file_id: fileId })
                });

                const data = await response.json();

                if (response.ok) {
                    loadFiles();
                } else {
                    alert('Delete failed: ' + (data.error || 'Unknown error'));
                }
            } catch (error) {
                alert('Delete failed: ' + error.message);
            }
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function getFileIcon(filename) {
            const ext = filename.split('.').pop().toLowerCase();
            const icons = {
                'mp4': 'üé¨', 'mkv': 'üé¨', 'avi': 'üé¨', 'mov': 'üé¨', 'wmv': 'üé¨',
                'mp3': 'üéµ', 'wav': 'üéµ', 'flac': 'üéµ',
                'jpg': 'üñºÔ∏è', 'jpeg': 'üñºÔ∏è', 'png': 'üñºÔ∏è', 'gif': 'üñºÔ∏è',
                'pdf': 'üìÑ', 'doc': 'üìÑ', 'docx': 'üìÑ',
                'zip': 'üì¶', 'rar': 'üì¶', '7z': 'üì¶'
            };
            return icons[ext] || 'üìÑ';
        }
    </script>
</body>
</html>
