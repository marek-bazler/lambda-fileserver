<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>File Server (Local)</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; background: #f5f5f5; }
        .container { max-width: 900px; margin: 0 auto; padding: 20px; }
        .card { background: white; border-radius: 8px; padding: 24px; margin-bottom: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .dev-banner { background: #ff6b6b; color: white; padding: 8px; text-align: center; font-weight: 500; }
        h1 { color: #333; margin-bottom: 24px; }
        h2 { color: #555; margin-bottom: 16px; font-size: 18px; }
        input, button { padding: 10px; border-radius: 4px; border: 1px solid #ddd; font-size: 14px; }
        input { width: 100%; margin-bottom: 12px; }
        button { background: #007bff; color: white; border: none; cursor: pointer; font-weight: 500; }
        button:hover { background: #0056b3; }
        button:disabled { background: #ccc; cursor: not-allowed; }
        .hidden { display: none; }
        .file-list { list-style: none; }
        .file-item { padding: 12px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; }
        .file-item:last-child { border-bottom: none; }
        .file-info { flex: 1; }
        .file-name { font-weight: 500; color: #333; }
        .file-meta { font-size: 12px; color: #888; margin-top: 4px; }
        .btn-small { padding: 6px 12px; font-size: 12px; margin-left: 8px; }
        .error { color: #dc3545; margin-top: 8px; font-size: 14px; }
        .success { color: #28a745; margin-top: 8px; font-size: 14px; }
        .upload-area { border: 2px dashed #ddd; border-radius: 4px; padding: 40px; text-align: center; cursor: pointer; margin-bottom: 16px; }
        .upload-area:hover { border-color: #007bff; background: #f8f9fa; }
        .logout-btn { float: right; background: #6c757d; }
        .logout-btn:hover { background: #545b62; }
        .info-box { background: #e7f3ff; border-left: 4px solid #007bff; padding: 12px; margin-bottom: 16px; font-size: 14px; }
    </style>
</head>
<body>
    <div class="dev-banner">LOCAL DEVELOPMENT MODE</div>
    
    <div class="container">
        <!-- Login Section -->
        <div id="loginSection" class="card">
            <h1>File Server Login</h1>
            <div class="info-box">
                <strong>Test Credentials:</strong><br>
                Username: test<br>
                Password: test123
            </div>
            <input type="text" id="username" placeholder="Username" value="test" />
            <input type="password" id="password" placeholder="Password" value="test123" />
            <button onclick="login()">Login</button>
            <div id="loginError" class="error hidden"></div>
        </div>

        <!-- Main Section -->
        <div id="mainSection" class="hidden">
            <div class="card">
                <h1>File Server <button class="logout-btn btn-small" onclick="logout()">Logout</button></h1>
                <p>Welcome, <strong id="currentUser"></strong></p>
            </div>

            <!-- Upload Section -->
            <div class="card">
                <h2>Upload Files</h2>
                <div class="upload-area" onclick="document.getElementById('fileInput').click()">
                    <p>Click to select files or drag and drop</p>
                    <p style="font-size: 12px; color: #888; margin-top: 8px;">Multiple files supported</p>
                </div>
                <input type="file" id="fileInput" multiple style="display: none;" onchange="handleFiles(this.files)" />
                <button onclick="uploadFiles()" id="uploadBtn" disabled>Upload Selected Files</button>
                <div id="uploadStatus" class="hidden"></div>
            </div>

            <!-- Files List -->
            <div class="card">
                <h2>Your Files</h2>
                <ul id="filesList" class="file-list"></ul>
            </div>
        </div>
    </div>

    <script>
        const API_ENDPOINT = 'http://localhost:5000';
        let token = localStorage.getItem('token');
        let selectedFiles = [];

        if (token) {
            document.getElementById('loginSection').classList.add('hidden');
            document.getElementById('mainSection').classList.remove('hidden');
            document.getElementById('currentUser').textContent = localStorage.getItem('username');
            loadFiles();
        }

        async function login() {
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            const errorDiv = document.getElementById('loginError');

            try {
                const response = await fetch(`${API_ENDPOINT}/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, password })
                });

                const data = await response.json();

                if (response.ok) {
                    token = data.token;
                    localStorage.setItem('token', token);
                    localStorage.setItem('username', username);
                    document.getElementById('loginSection').classList.add('hidden');
                    document.getElementById('mainSection').classList.remove('hidden');
                    document.getElementById('currentUser').textContent = username;
                    loadFiles();
                } else {
                    errorDiv.textContent = data.error || 'Login failed';
                    errorDiv.classList.remove('hidden');
                }
            } catch (error) {
                errorDiv.textContent = 'Network error: ' + error.message;
                errorDiv.classList.remove('hidden');
            }
        }

        function logout() {
            localStorage.removeItem('token');
            localStorage.removeItem('username');
            location.reload();
        }

        function handleFiles(files) {
            selectedFiles = Array.from(files);
            document.getElementById('uploadBtn').disabled = selectedFiles.length === 0;
            document.getElementById('uploadStatus').innerHTML = `<p>${selectedFiles.length} file(s) selected</p>`;
            document.getElementById('uploadStatus').classList.remove('hidden');
        }

        async function uploadFiles() {
            if (selectedFiles.length === 0) return;

            const statusDiv = document.getElementById('uploadStatus');
            statusDiv.innerHTML = '<p>Processing files...</p>';
            statusDiv.className = '';

            let successCount = 0;
            let duplicateCount = 0;
            let errorCount = 0;

            for (let i = 0; i < selectedFiles.length; i++) {
                const file = selectedFiles[i];
                statusDiv.innerHTML = `<p>Processing ${i + 1}/${selectedFiles.length}: ${file.name}</p>`;

                try {
                    // Calculate file hash for duplicate detection
                    const fileHash = await calculateFileHash(file);

                    // Check for duplicate
                    const dupCheck = await fetch(`${API_ENDPOINT}/check-duplicate`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${token}`
                        },
                        body: JSON.stringify({ file_hash: fileHash })
                    });

                    const dupData = await dupCheck.json();

                    if (dupData.duplicate) {
                        duplicateCount++;
                        statusDiv.innerHTML = `<p>Processing ${i + 1}/${selectedFiles.length}: ${file.name} (duplicate, skipped)</p>`;
                        continue;
                    }

                    // Get presigned upload URL
                    const urlResponse = await fetch(`${API_ENDPOINT}/upload`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${token}`
                        },
                        body: JSON.stringify({
                            files: [{
                                filename: file.name,
                                content_type: file.type || 'video/mp4',
                                size: file.size
                            }]
                        })
                    });

                    const urlData = await urlResponse.json();
                    const uploadInfo = urlData.upload_urls[0];

                    // Upload directly to S3 with progress
                    statusDiv.innerHTML = `<p>Uploading ${i + 1}/${selectedFiles.length}: ${file.name} (0%)</p>`;

                    let uploadResult;
                    try {
                        if (uploadInfo.upload_type === 'multipart') {
                            uploadResult = await uploadMultipart(file, uploadInfo, (percent) => {
                                statusDiv.innerHTML = `<p>Uploading ${i + 1}/${selectedFiles.length}: ${file.name} (${percent}%) [Multipart]</p>`;
                            });
                        } else {
                            uploadResult = await uploadSimple(file, uploadInfo, (percent) => {
                                statusDiv.innerHTML = `<p>Uploading ${i + 1}/${selectedFiles.length}: ${file.name} (${percent}%)</p>`;
                            });
                        }
                    } catch (uploadError) {
                        console.error('S3 upload failed:', uploadError);
                        throw new Error(`S3 upload failed: ${uploadError.message}`);
                    }

                    // Notify backend of successful upload
                    await fetch(`${API_ENDPOINT}/upload-complete`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${token}`
                        },
                        body: JSON.stringify({
                            file_id: uploadInfo.file_id,
                            filename: file.name,
                            file_hash: fileHash,
                            size: file.size,
                            content_type: uploadInfo.content_type,
                            upload_id: uploadResult.upload_id,
                            parts: uploadResult.parts
                        })
                    });

                    successCount++;
                } catch (error) {
                    console.error('Upload error:', error);
                    statusDiv.innerHTML = `<p class="error">Error uploading ${file.name}: ${error.message}</p>`;
                    errorCount++;
                }
            }

            if (errorCount > 0) {
                statusDiv.innerHTML = `<p class="error">✗ ${successCount} uploaded, ${duplicateCount} duplicates skipped, ${errorCount} errors</p>`;
            } else {
                statusDiv.innerHTML = `<p class="success">✓ ${successCount} uploaded, ${duplicateCount} duplicates skipped</p>`;
            }
            selectedFiles = [];
            document.getElementById('fileInput').value = '';
            document.getElementById('uploadBtn').disabled = true;
            loadFiles();
        }

        async function uploadSimple(file, uploadInfo, onProgress) {
            return new Promise((resolve, reject) => {
                const xhr = new XMLHttpRequest();
                
                xhr.upload.addEventListener('progress', (e) => {
                    if (e.lengthComputable) {
                        const percent = Math.round((e.loaded / e.total) * 100);
                        onProgress(percent);
                    }
                });

                xhr.addEventListener('load', () => {
                    console.log('Upload response status:', xhr.status);
                    console.log('Upload response:', xhr.responseText);
                    if (xhr.status === 200 || xhr.status === 204) {
                        resolve({});
                    } else {
                        reject(new Error(`Upload failed with status ${xhr.status}: ${xhr.responseText}`));
                    }
                });

                xhr.addEventListener('error', (e) => {
                    console.error('XHR error:', e);
                    reject(new Error('Network error during upload'));
                });

                console.log('Uploading to:', uploadInfo.upload_url);
                xhr.open('PUT', uploadInfo.upload_url);
                xhr.setRequestHeader('Content-Type', uploadInfo.content_type);
                xhr.send(file);
            });
        }

        async function uploadMultipart(file, uploadInfo, onProgress) {
            const partSize = uploadInfo.part_size;
            const parts = [];
            let uploadedBytes = 0;

            for (let i = 0; i < uploadInfo.part_urls.length; i++) {
                const start = i * partSize;
                const end = Math.min(start + partSize, file.size);
                const chunk = file.slice(start, end);

                const response = await fetch(uploadInfo.part_urls[i], {
                    method: 'PUT',
                    body: chunk
                });

                if (!response.ok) {
                    throw new Error(`Part ${i + 1} upload failed`);
                }

                const etag = response.headers.get('ETag');
                parts.push({
                    PartNumber: i + 1,
                    ETag: etag
                });

                uploadedBytes += chunk.size;
                const percent = Math.round((uploadedBytes / file.size) * 100);
                onProgress(percent);
            }

            return {
                upload_id: uploadInfo.upload_id,
                parts: parts
            };
        }

        async function calculateFileHash(file) {
            const buffer = await file.arrayBuffer();
            const hashBuffer = await crypto.subtle.digest('SHA-256', buffer);
            const hashArray = Array.from(new Uint8Array(hashBuffer));
            return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
        }

        async function loadFiles() {
            try {
                const response = await fetch(`${API_ENDPOINT}/files`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                const data = await response.json();

                if (response.ok) {
                    const filesList = document.getElementById('filesList');
                    if (data.files.length === 0) {
                        filesList.innerHTML = '<li class="file-item">No files uploaded yet</li>';
                    } else {
                        filesList.innerHTML = data.files.map(file => `
                            <li class="file-item">
                                <div class="file-info">
                                    <div class="file-name">${escapeHtml(file.filename)}</div>
                                    <div class="file-meta">${formatBytes(file.size)} • ${new Date(file.uploaded_at).toLocaleString()}</div>
                                </div>
                                <button class="btn-small" onclick="downloadFile('${file.file_id}', '${escapeHtml(file.filename)}')">Download</button>
                            </li>
                        `).join('');
                    }
                }
            } catch (error) {
                console.error('Failed to load files', error);
            }
        }

        async function downloadFile(fileId, filename) {
            try {
                const response = await fetch(`${API_ENDPOINT}/download?file_id=${encodeURIComponent(fileId)}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                const data = await response.json();

                if (response.ok) {
                    window.open(data.download_url, '_blank');
                }
            } catch (error) {
                alert('Download failed: ' + error.message);
            }
        }



        function formatBytes(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i];
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
    </script>
</body>
</html>
